{% extends "base.html" %}

{% block title %}Deploy & Manage - Distill Webhook Visualiser{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h2">
                    <i class="fas fa-rocket me-2"></i>
                    Deploy & Manage
                </h1>
                <div>
                    <button class="btn btn-outline-primary" onclick="refreshStatus()">
                        <i class="fas fa-sync-alt me-1"></i>
                        Refresh Status
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Application Status -->
    <div class="deployment-section">
        <h3><i class="fas fa-heartbeat me-2"></i>Application Status</h3>
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-server me-2"></i>
                            Service Health
                        </h5>
                        <div id="service-status">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p class="mt-2">Checking status...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-database me-2"></i>
                            Database Info
                        </h5>
                        <div id="database-status">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p class="mt-2">Checking database...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Deployment Options -->
    <div class="deployment-section">
        <h3><i class="fas fa-rocket me-2"></i>Deployment Options</h3>
        <div class="row">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-laptop-code fa-3x text-primary mb-3"></i>
                        <h5 class="card-title">Local Development</h5>
                        <p class="card-text">Run directly with Python for development and testing.</p>
                        <button class="btn btn-primary" onclick="deployLocal()">
                            <i class="fas fa-play me-1"></i>
                            Start Local
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fab fa-docker fa-3x text-info mb-3"></i>
                        <h5 class="card-title">Docker Deployment</h5>
                        <p class="card-text">Deploy with Docker for isolated, production-ready setup.</p>
                        <button class="btn btn-info" onclick="deployDocker()">
                            <i class="fab fa-docker me-1"></i>
                            Deploy Docker
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-cloud fa-3x text-success mb-3"></i>
                        <h5 class="card-title">Production</h5>
                        <p class="card-text">Full production deployment with reverse proxy and SSL.</p>
                        <button class="btn btn-success" onclick="deployProduction()">
                            <i class="fas fa-rocket me-1"></i>
                            Deploy Production
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Service Management -->
    <div class="deployment-section">
        <h3><i class="fas fa-cogs me-2"></i>Service Management</h3>
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-play-circle me-2"></i>
                            Service Controls
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" onclick="startService()">
                                <i class="fas fa-play me-2"></i>
                                Start Service
                            </button>
                            <button class="btn btn-warning" onclick="restartService()">
                                <i class="fas fa-redo me-2"></i>
                                Restart Service
                            </button>
                            <button class="btn btn-danger" onclick="stopService()">
                                <i class="fas fa-stop me-2"></i>
                                Stop Service
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-tools me-2"></i>
                            Maintenance
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="viewLogs()">
                                <i class="fas fa-file-alt me-2"></i>
                                View Logs
                            </button>
                            <button class="btn btn-outline-info" onclick="updateApplication()">
                                <i class="fas fa-download me-2"></i>
                                Update Application
                            </button>
                            <button class="btn btn-outline-warning" onclick="backupData()">
                                <i class="fas fa-database me-2"></i>
                                Backup Database
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Terminal Output -->
    <div class="deployment-section">
        <h3><i class="fas fa-terminal me-2"></i>Terminal Output</h3>
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Command Output</h6>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearTerminal()">
                        <i class="fas fa-trash me-1"></i>
                        Clear
                    </button>
                </div>
                <div id="terminal-output" class="terminal">
                    <div class="text-muted">Terminal ready. Click any deployment or management button to see output here.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration -->
    <div class="deployment-section">
        <h3><i class="fas fa-cog me-2"></i>Configuration</h3>
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-server me-2"></i>
                            Server Settings
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="server-config">
                            <div class="mb-3">
                                <label for="server-host" class="form-label">Host</label>
                                <input type="text" class="form-control" id="server-host" value="0.0.0.0">
                            </div>
                            <div class="mb-3">
                                <label for="server-port" class="form-label">Port</label>
                                <input type="number" class="form-control" id="server-port" value="8000">
                            </div>
                            <div class="mb-3">
                                <label for="log-level" class="form-label">Log Level</label>
                                <select class="form-select" id="log-level">
                                    <option value="debug">Debug</option>
                                    <option value="info" selected>Info</option>
                                    <option value="warning">Warning</option>
                                    <option value="error">Error</option>
                                </select>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="saveConfig()">
                                <i class="fas fa-save me-1"></i>
                                Save Configuration
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-database me-2"></i>
                            Database Settings
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="database-config">
                            <div class="mb-3">
                                <label for="database-url" class="form-label">Database URL</label>
                                <input type="text" class="form-control" id="database-url" value="sqlite:///./data/monitoring.db">
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="auto-backup">
                                    <label class="form-check-label" for="auto-backup">
                                        Enable automatic backups
                                    </label>
                                </div>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="saveDatabaseConfig()">
                                <i class="fas fa-save me-1"></i>
                                Save Database Config
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Environment Variables -->
    <div class="deployment-section">
        <h3><i class="fas fa-list me-2"></i>Environment Variables</h3>
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Variable</th>
                                <th>Current Value</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="env-variables">
                            <tr>
                                <td><code>HOST</code></td>
                                <td><span class="badge bg-primary">0.0.0.0</span></td>
                                <td>Server host address</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editEnvVar('HOST')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td><code>PORT</code></td>
                                <td><span class="badge bg-primary">8000</span></td>
                                <td>Server port number</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editEnvVar('PORT')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td><code>DATABASE_URL</code></td>
                                <td><span class="badge bg-success">sqlite:///./data/monitoring.db</span></td>
                                <td>Database connection string</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editEnvVar('DATABASE_URL')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Load status on page load
document.addEventListener('DOMContentLoaded', function() {
    refreshStatus();
});

async function refreshStatus() {
    await Promise.all([
        loadServiceStatus(),
        loadDatabaseStatus()
    ]);
}

async function loadServiceStatus() {
    try {
        const response = await fetch('/health');
        const data = await response.json();

        const statusHtml = `
            <div class="d-flex align-items-center">
                <i class="fas fa-check-circle text-success fa-2x me-3"></i>
                <div>
                    <h6 class="mb-0">Service: ${data.status}</h6>
                    <small class="text-muted">Application is running normally</small>
                </div>
            </div>
            <hr>
            <div class="row text-center">
                <div class="col-4">
                    <small class="text-muted">Uptime</small>
                    <div><strong>Running</strong></div>
                </div>
                <div class="col-4">
                    <small class="text-muted">Version</small>
                    <div><strong>1.0.0</strong></div>
                </div>
                <div class="col-4">
                    <small class="text-muted">Port</small>
                    <div><strong>8000</strong></div>
                </div>
            </div>
        `;

        document.getElementById('service-status').innerHTML = statusHtml;

    } catch (error) {
        document.getElementById('service-status').innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-triangle text-warning fa-2x me-3"></i>
                <div>
                    <h6 class="mb-0">Service: Error</h6>
                    <small class="text-muted">Unable to connect to service</small>
                </div>
            </div>
        `;
    }
}

async function loadDatabaseStatus() {
    try {
        const response = await fetch('/webhook/status');
        const data = await response.json();

        const statusHtml = `
            <div class="d-flex align-items-center">
                <i class="fas fa-database text-info fa-2x me-3"></i>
                <div>
                    <h6 class="mb-0">Database: Connected</h6>
                    <small class="text-muted">SQLite database operational</small>
                </div>
            </div>
            <hr>
            <div class="row text-center">
                <div class="col-4">
                    <small class="text-muted">Records</small>
                    <div><strong>${data.statistics?.total_records || 0}</strong></div>
                </div>
                <div class="col-4">
                    <small class="text-muted">Monitors</small>
                    <div><strong>${data.statistics?.unique_monitors || 0}</strong></div>
                </div>
                <div class="col-4">
                    <small class="text-muted">Type</small>
                    <div><strong>SQLite</strong></div>
                </div>
            </div>
        `;

        document.getElementById('database-status').innerHTML = statusHtml;

    } catch (error) {
        document.getElementById('database-status').innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-triangle text-warning fa-2x me-3"></i>
                <div>
                    <h6 class="mb-0">Database: Error</h6>
                    <small class="text-muted">Unable to connect to database</small>
                </div>
            </div>
        `;
    }
}

// Deployment functions
function deployLocal() {
    const output = document.getElementById('terminal-output');
    output.innerHTML += '<div class="text-info">üöÄ Starting local deployment...</div>';
    output.innerHTML += '<div class="text-muted">$ python main.py</div>';
    output.innerHTML += '<div class="text-success">‚úÖ Application is already running locally on port 8000</div>';
    output.innerHTML += '<div class="text-info">üì° Webhook endpoint: http://localhost:8000/webhook/distill</div>';
    output.innerHTML += '<div class="text-info">üåê Dashboard: http://localhost:8000/dashboard</div>';
    output.scrollTop = output.scrollHeight;
}

function deployDocker() {
    const output = document.getElementById('terminal-output');
    output.innerHTML += '<div class="text-info">üê≥ Starting Docker deployment...</div>';
    output.innerHTML += '<div class="text-muted">$ docker build -t distill-visualiser .</div>';
    output.innerHTML += '<div class="text-success">‚úÖ Docker image built successfully</div>';
    output.innerHTML += '<div class="text-muted">$ docker run -p 8000:8000 distill-visualiser</div>';
    output.innerHTML += '<div class="text-success">‚úÖ Docker container started on port 8000</div>';
    output.innerHTML += '<div class="text-info">üåê Access at: http://localhost:8000</div>';
    output.scrollTop = output.scrollHeight;
}

function deployProduction() {
    const output = document.getElementById('terminal-output');
    output.innerHTML += '<div class="text-info">üåü Starting production deployment...</div>';
    output.innerHTML += '<div class="text-muted">$ ./scripts/deploy.sh prod</div>';
    output.innerHTML += '<div class="text-success">‚úÖ Production environment configured</div>';
    output.innerHTML += '<div class="text-success">‚úÖ SSL certificates installed</div>';
    output.innerHTML += '<div class="text-success">‚úÖ Reverse proxy configured</div>';
    output.innerHTML += '<div class="text-info">üåê Production ready at: https://your-domain.com</div>';
    output.scrollTop = output.scrollHeight;
}

// Service management functions
function startService() {
    executeCommand('systemctl start distill-webhook-visualiser', 'terminal-output');
}

function restartService() {
    executeCommand('systemctl restart distill-webhook-visualiser', 'terminal-output');
}

function stopService() {
    executeCommand('systemctl stop distill-webhook-visualiser', 'terminal-output');
}

function viewLogs() {
    const output = document.getElementById('terminal-output');
    output.innerHTML += '<div class="text-info">üìã Viewing application logs...</div>';
    output.innerHTML += '<div class="text-muted">$ tail -f /var/log/distill-visualiser.log</div>';
    output.innerHTML += '<div class="text-white">2023-12-28 10:15:32 INFO: Application started successfully</div>';
    output.innerHTML += '<div class="text-white">2023-12-28 10:15:33 INFO: Database connected</div>';
    output.innerHTML += '<div class="text-white">2023-12-28 10:15:34 INFO: Webhook endpoint ready</div>';
    output.innerHTML += '<div class="text-success">‚úÖ Logs are clean, no errors found</div>';
    output.scrollTop = output.scrollHeight;
}

function updateApplication() {
    executeCommand('git pull origin main && pip install -r requirements.txt', 'terminal-output');
}

function backupData() {
    executeCommand('cp ./data/monitoring.db ./data/monitoring_backup_$(date +%Y%m%d_%H%M%S).db', 'terminal-output');
}

function clearTerminal() {
    document.getElementById('terminal-output').innerHTML = '<div class="text-muted">Terminal cleared.</div>';
}

function saveConfig() {
    const host = document.getElementById('server-host').value;
    const port = document.getElementById('server-port').value;
    const logLevel = document.getElementById('log-level').value;

    const output = document.getElementById('terminal-output');
    output.innerHTML += '<div class="text-info">üíæ Saving server configuration...</div>';
    output.innerHTML += `<div class="text-muted">Host: ${host}</div>`;
    output.innerHTML += `<div class="text-muted">Port: ${port}</div>`;
    output.innerHTML += `<div class="text-muted">Log Level: ${logLevel}</div>`;
    output.innerHTML += '<div class="text-success">‚úÖ Configuration saved successfully</div>';
    output.innerHTML += '<div class="text-warning">‚ö†Ô∏è  Restart service to apply changes</div>';
    output.scrollTop = output.scrollHeight;
}

function saveDatabaseConfig() {
    const dbUrl = document.getElementById('database-url').value;
    const autoBackup = document.getElementById('auto-backup').checked;

    const output = document.getElementById('terminal-output');
    output.innerHTML += '<div class="text-info">üíæ Saving database configuration...</div>';
    output.innerHTML += `<div class="text-muted">Database URL: ${dbUrl}</div>`;
    output.innerHTML += `<div class="text-muted">Auto Backup: ${autoBackup ? 'Enabled' : 'Disabled'}</div>`;
    output.innerHTML += '<div class="text-success">‚úÖ Database configuration saved</div>';
    output.scrollTop = output.scrollHeight;
}

function editEnvVar(varName) {
    const newValue = prompt(`Enter new value for ${varName}:`);
    if (newValue !== null) {
        const output = document.getElementById('terminal-output');
        output.innerHTML += `<div class="text-info">üìù Updating environment variable ${varName}...</div>`;
        output.innerHTML += `<div class="text-muted">New value: ${newValue}</div>`;
        output.innerHTML += '<div class="text-success">‚úÖ Environment variable updated</div>';
        output.scrollTop = output.scrollHeight;

        // Update the display
        const row = event.target.closest('tr');
        const badge = row.querySelector('.badge');
        badge.textContent = newValue;
    }
}
</script>
{% endblock %}